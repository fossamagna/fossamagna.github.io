---
title: Amplify CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã£ã¦ã©ã†ãªã£ã¦ã‚‹ã®ï¼Ÿ
date: "2021-12-20T09:15:29+09:00"
---

ã“ã®è¨˜äº‹ã¯ [AWS Amplify Advent Calendar 2021](https://qiita.com/advent-calendar/2021/amplify) ã¨ [ESM Advent Calendar 2021](https://adventar.org/calendars/6972) ã® 20 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

Amplify CLI v7.3.0 ã§ CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¾ã—ãŸã€‚ã‹ãªã‚Šç†±ã„æ©Ÿèƒ½ã§ã™ã€‚
Amplify ã® CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã¯ã©ã†ã‚„ã£ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’èª¿ã¹ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

## ã©ã†ã—ã¦ CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’èª¿ã¹ãŸã®ã‹

[amplify-category-console-notification](https://github.com/fossamagna/amplify-category-console-notification)[^1]ã¨ã„ã† amplfy ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã§ã™ãŒã€
ãã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚‚`amplify console-notification override`ã®ã‚ˆã†ã«åˆ©ç”¨è€…ãŒè¨­å®šã‚’ä¸Šæ›¸ãã§ãã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ãŸã„ã¨ã„ã†ã®ãŒå‹•æ©Ÿã§ã™ã€‚
ãã®ãŸã‚ã€CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹ï¼Ÿã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«å®Ÿè£…ãŒã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ãªãŠã€ã“ã®è¨˜äº‹ã§ã¯[amplify cli v7.6.3](https://github.com/aws-amplify/amplify-cli/releases/tag/v7.6.3)ã‚’å¯¾è±¡ã«èª¿ã¹ã¦ã„ã¾ã™ã€‚

[^1]: [AWS Amplify Advent Calendar 2021 16 æ—¥ç›®ã®è¨˜äº‹](https://qiita.com/dyson-udonsin/items/5d2b7105736bf8a742c4)ã§ç´¹ä»‹ã„ãŸã ã„ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚

## ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã¨ã¯

ãã‚‚ãã‚‚ã€ã€ŒAmplify CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã¨ã¯ä½•ã‹ã€ã§ã™ãŒã€Amplify ãŒç”Ÿæˆã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ï¼ˆã®ä¸€éƒ¨ï¼‰ã‚’ CDK ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚ä»Šã¾ã§ã¯ç”Ÿæˆã•ã‚ŒãŸ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ãŸã®ã‚’ CDK ã‚’åˆ©ç”¨ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨ã„ã†ã‚‚ã®ã§ã™ã€‚
è©³ã—ãã¯[Amplify ã§ç”Ÿæˆã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚’ CDK ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–°æ©Ÿèƒ½ ã€Œã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã€ã®ã”ç´¹ä»‹](https://aws.amazon.com/jp/blogs/news/override-amplify-generated-backend-resources-using-cdk/)ã¨ã„ã† Amazon Web Services ãƒ–ãƒ­ã‚°ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã„ãŸã ãã¨ä¸€é€šã‚ŠæŠŠæ¡ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

## ã©ã†ãªã£ã¦ã‚‹ï¼Ÿ

æ¬¡ã® 2 ç‚¹ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ã¨ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’æä¾›ï¼ˆå®Ÿè£…ï¼‰ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

- `amplify override` ã¯ã©ã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- `amplify push` ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã©ã® API ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã®ã‹(ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã©ã® API ã‚’å®Ÿè£…ã™ã‚Œã°ã„ã„ã®ã‹)

ãã“ã§ã€ã“ã® 2 ç‚¹ã«ã¤ã„ã¦ã©ã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã„ãã¾ã™ã€‚
amplify ã§ã¯ overide ã¯`auth`, `storage`, `api`ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã“ã§ã¯`storage`ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«çµã£ã¦æ¢ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

### `amplify category override` ã®å®Ÿè£…ã‚’è¦‹ã‚‹

ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã¾ãšæ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ amplify storage override
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`storage`ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã®ã‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å•ã„åˆã‚ã›ã¦ã‹ã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

[amplify-category-storage/src/commands/storage/override.ts#L58-L83](https://github.com/aws-amplify/amplify-cli/blob/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/commands/storage/override.ts#L58-L83):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/commands/storage/override.ts#L58-L83
```

ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç¨®é¡ãŒ DynamoDB ã‹ S3 ã‹ã§åˆ†å²ã—ã¦ã„ã¾ã™ãŒã€ã©ã¡ã‚‰ã‚‚åŒã˜ã‚ˆã†ãªå‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã®ã§ã€DynamoDB ã®æ–¹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯æ¬¡ã®å‡¦ç†ã§ã™ã€‚

1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
2. ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ã«å•ã„åˆã‚ã›ãŸå¾Œã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚‚ã¨ã« CDK ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
4. æœ€å¾Œã«`generateOverrideSkeleton`é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿…è¦æ€§ã®ãƒã‚§ãƒƒã‚¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã¯`DynamoDBInputState`[^2]ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã‹ã®ãƒã‚§ãƒƒã‚¯ã§ã™ãŒã€`cliInputFileExists`é–¢æ•°ãŒãã®å½¹å‰²ã§ã™ã€‚`cli-input.json`[^3]ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰ç„¡ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã‚ã‚‹ã‹åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚

[amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L47-L49](https://github.com/aws-amplify/amplify-cli/blob/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L47-L49):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L47-L49

```

[^2]:
    ã“ã®`DynamoDBInputState`ã¯ä½•ã‹ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¦ã¯ã„ã¾ã›ã‚“ãŒã€`/* Need to move this logic to a base class */` ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆãŒæ›¸ã‹ã‚Œã¦ãŠã‚Šã€
    `auth`ã‚«ãƒ†ã‚´ãƒªã®ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨åŒã˜ã‚ˆã†ãªå½¹å‰²ã®`AuthInputState`ã‚¯ãƒ©ã‚¹ãŒ`CategoryInputState`ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚
    ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€`CategoryInputState`ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦å®Ÿè£…ã™ã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚


[^3]: `cli-input.json`ã«ã¤ã„ã¦å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã€ã¾ã è¨˜è¼‰ã¯ãªã„ã‚ˆã†ã§ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’ä¿å­˜ã—ã¦ãŠãã€CDK ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯`migrate`é–¢æ•°ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯æ—¢å­˜ã®`parameters.json`,Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«,`storage-params.json`ã‚’èª­ã¿è¾¼ã‚“ã§`cli-input.json`ã‚’ä½œæˆã—ã¾ã™ã€‚
ãã—ã¦ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

[amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L71-L161](https://github.com/aws-amplify/amplify-cli/blob/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L71-L161):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/dacdff9136a385ca99797fffb45e810d8f378568/packages/amplify-category-storage/src/provider-utils/awscloudformation/service-walkthroughs/dynamoDB-input-state.ts#L71-L161

```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¬¡ã«ã€`DDBStackTransform.transform()`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
`transform()`é–¢æ•°ã§ã¯ã€`cli-input.json`ã‹ã‚‰ Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(`cloudformation.json`)ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(`parameters.json`)ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚
`applyOverrides`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸå†…å®¹(`override.ts`)ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«é©ç”¨ã™ã‚‹å‡¦ç†ã‚‚å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ãŸã ã—ã€ã“ã®æ™‚ç‚¹ã§ã¯`override.ts`ã¯ã¾ã å­˜åœ¨ã—ã¦ã„ãªã„ã®ã§ä½•ã‚‚ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚Œã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

[amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/s3-stack-transform.ts#L60-L70](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/s3-stack-transform.ts#L60-L70):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/s3-stack-transform.ts#L60-L70

```

æœ€å¾Œã«ã€`generateOverrideSkeleton`é–¢æ•°ã®å‘¼ã³å‡ºã—ã§ã™ã€‚`generateOverrideSkeleton`é–¢æ•°ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã«å¿…è¦ãª`tsconfig.json`ã‚„`override.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã—ã¦ãã‚Œã‚‹é–¢æ•°ã§ã™ã€‚
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã‚‚ã€ã“ã®é–¢æ•°ã‚’é©åˆ‡ãªå¼•æ•°ã§å‘¼ã³å‡ºã›ã°è‰¯ã•ãã†ã§ã™ã€‚

ã“ã“ã¾ã§è¦‹ã¦ããŸå†…å®¹ã‚’è¸ã¾ãˆã‚‹ã¨ `amplify overide <category>` ã‚³ãƒãƒ³ãƒ‰ã¯å®Ÿè£…ã§ããã†ã§ã™ã€‚

### `amplify push` ã®å®Ÿè£…ã‚’è¦‹ã‚‹

æ¬¡ã«ã€`amplify push` ã‚’å®Ÿè¡Œã—ãŸã¨ãã« CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆ`override.ts`ï¼‰ã®ã‚³ãƒ¼ãƒ‰ãŒã©ã®ã‚ˆã†ã«åæ˜ ã•ã‚Œã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã®ã‹è¦‹ã¦ã¿ã¾ã™ã€‚
`amplify push`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `amplify-cli/src/extensions/amplify-helpers/push-resources.ts` ã® `pushResource`é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

#### `override.ts`ã®ãƒ“ãƒ«ãƒ‰ã¨ Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

`pushResource`é–¢æ•°ã®ä¸­ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã€`context.amplify.executeProviderUtils(context, 'awscloudformation', 'buildOverrides', {...})`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

[amplify-cli/src/extensions/amplify-helpers/push-resources.ts#L57-L63](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-cli/src/extensions/amplify-helpers/push-resources.ts#L57-L63):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-cli/src/extensions/amplify-helpers/push-resources.ts#L57-L63

```

`context.amplify.executeProviderUtils(context, 'awscloudformation', 'buildOverrides', {...})`ã‚’å‘¼ã³å‡ºã™ã¨ä»¥ä¸‹ã«ç¤ºã™é–¢æ•°ãŒé †æ¬¡å‘¼ã³å‡ºã•ã‚Œã¦ã„ãã¾ã™ã€‚

1. [amplify-provider-awscloudformation/src/utility-functions.js#L66-L75](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/utility-functions.js#L66-L75):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/utility-functions.js#L66-L75

```

ã“ã“ã§ãƒªã‚½ãƒ¼ã‚¹æ¯ã«`transformResourceWithOverrides`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚ 

2. [amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L16-L66](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L16-L66):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L16-L66

```

`transformResourceWithOverrides`é–¢æ•°ã§ã¯æŒ‡å®šã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå®Ÿè£…ã™ã‚‹`transformCategoryStack`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚ 

3. [amplify-category-storage/src/index.ts#L115-L124](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/index.ts#L115-L124):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/index.ts#L115-L124

```

`amplify-category-storage`ã®`transformCategoryStack`é–¢æ•°ã¯ DynamoDB ã®ãƒªã‚½ãƒ¼ã‚¹ã§ã‚ã‚Œã°`DDBStackTransform.transform()`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ã“ã®`transform`é–¢æ•°ã¯ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã§ã‚‚å‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã—ãŸã­ã€‚ã“ã®é–¢æ•°ã§å‘¼ã³ã ã•ã‚Œã‚‹`applyOverrides`é–¢æ•°ã§`override.ts`ã®å†…å®¹ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ã€‚æ¬¡ã§è©³ç´°ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ 

4. [amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L173-L215](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L173-L215):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L173-L215

```

`buildOverrideDir`é–¢æ•°ã§`override.ts`ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦`override.js`ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚‰`new vm.NodeVM({...})`ã§ä½œæˆã—ãŸ Node.js ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒå†…ã§`override`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®å†…å®¹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«åæ˜ ã—ã¾ã™ã€‚ 

5. [amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L217-L239](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L217-L239):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-category-storage/src/provider-utils/awscloudformation/cdk-stack-builder/ddb-stack-transform.ts#L217-L239

```

`DDBStackTransform.transform()`é–¢æ•°ã¯`applyOverrides`é–¢æ•°ã®å¾Œã«`saveBuildFiles`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®å†…å®¹ã‚’åæ˜ ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ Cfn ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã—ã¾ã™ã€‚åŒæ™‚ã«`parameters.json`ã‚‚å‡ºåŠ›ã—ã¾ã™ã€‚

ã“ã“ã¾ã§ã§ã€`amplify push`ã‚’å®Ÿè¡Œã—ãŸã¨ãã«`override.ts`ãŒã©ã†ãƒ“ãƒ«ãƒ‰ãƒ»åæ˜ ã•ã‚Œã¦ Cfn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã‹æŠŠæ¡ã§ãã¾ã—ãŸã€‚
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã“ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€å•é¡Œã«ãªã‚‹ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã€ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå®Ÿè£…ã™ã‚‹`transformCategoryStack`é–¢æ•°ã‚’å–å¾—ã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚

[amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L22](https://github.com/aws-amplify/amplify-cli/blob/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L22):

```ts raw_url=https://raw.githubusercontent.com/aws-amplify/amplify-cli/b3ca83b9bec986f0fd525d46738b277eb93e4384/packages/amplify-provider-awscloudformation/src/override-manager/transform-resource.ts#L22

```

ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒ`@aws-amplify/amplify-category-`ã§å§‹ã¾ã‚‹ã‚‚ã®ã«é™å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€å…¬å¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã¿ã‚’å¯¾è±¡ã«ã—ã¦ã„ã¾ã™ã€‚
`transformCategoryStack`é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã‚‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å´ã‹ã‚‰ãã®é–¢æ•°ã‚’ amplify-cli å´ã«æä¾›ã§ããªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚ğŸ˜¢

### å®Ÿè£…ã«å‘ã‘ãŸæ´»å‹•

ã“ã®ã¾ã¾ã§ã¯ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ Amplify CLI ãŒæä¾›ã—ã¦ã„ã‚‹ CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã¨åŒã˜ä»•çµ„ã¿ã«ä¹—ã£ã‹ã£ã¦æ©Ÿèƒ½æä¾›ã™ã‚‹ã®ã¯é›£ã—ãã†ãªã®ã§ã® GitHub ã® amplify-cli ãƒªãƒã‚¸ãƒˆãƒªã§ Issue ã‚’å‡ºã—ã¾ã—ãŸã€‚

https://github.com/aws-amplify/amplify-cli/issues/9226

ä»Šå¾Œã¯ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ CDK ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãŒå®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ã€ã“ã® Issue ã¸ã® Pull Request ã‚‚å‡ºã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
